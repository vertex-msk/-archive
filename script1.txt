#!/bin/bash

set -e  # прерывать при ошибке
set -u  # ошибка при использовании неинициализированной переменной

# === Функция проверки сервиса ===
check_service() {
    local service=$1
    if systemctl is-active --quiet "$service"; then
        echo "[OK] Сервис $service работает."
    else
        echo "[WARN] Сервис $service НЕ запущен!"
    fi
}

# === Функция проверки порта ===
check_port() {
    local port=$1
    local service=$2
    if ss -tuln | grep -q ":$port "; then
        echo "[OK] Порт $port ($service) слушает соединения."
    else
        echo "[WARN] Порт $port ($service) НЕ слушает!"
    fi
}

# === Функция проверки Apache через HTTP ===
check_apache_http() {
    if curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1 | grep -q "200"; then
        echo "[OK] Apache отвечает на HTTP-запросы."
    else
        echo "[WARN] Apache НЕ отвечает на HTTP-запросы!"
    fi
}

# === Проверка интернета ===
echo "[INFO] Проверяем соединение с интернетом..."
if ping -c 2 8.8.8.8 >/dev/null 2>&1; then
    echo "[OK] Интернет доступен."
else
    echo "[ERROR] Нет соединения с интернетом. Проверьте сеть!"
    exit 1
fi

# === 1. Добавление репозитория Backports, если отсутствует ===
BACKPORTS_REPO="deb http://http.kali.org/kali kali-rolling-backports main contrib non-free non-free-firmware"

if grep -Rqs "kali-rolling-backports" /etc/apt/sources.list /etc/apt/sources.list.d/*.list 2>/dev/null; then
    echo "[OK] Репозиторий backports уже есть."
else
    echo "[INFO] Добавляем репозиторий backports..."
    echo "" | sudo tee -a /etc/apt/sources.list
    echo "# Kali Linux Backports" | sudo tee -a /etc/apt/sources.list
    echo "$BACKPORTS_REPO" | sudo tee -a /etc/apt/sources.list
fi

# === 2. Обновление пакетного менеджера ===
echo "[INFO] Обновляем список пакетов..."
sudo apt update -y && sudo apt upgrade -y

# === 3. Установка и запуск Apache2 ===
echo "[INFO] Устанавливаем Apache2..."
sudo apt install -y apache2 curl
sudo systemctl enable apache2
sudo systemctl start apache2
check_service apache2
check_port 80 "Apache2"
check_apache_http

# === 4. Установка Python ===
echo "[INFO] Устанавливаем Python..."
sudo apt install -y python3 python3-pip
echo "[OK] Python установлен."

# === 5. Установка и поднятие SSH-сервера ===
echo "[INFO] Устанавливаем и запускаем SSH-сервер..."
sudo apt install -y openssh-server
sudo systemctl enable ssh
sudo systemctl start ssh
check_service ssh
check_port 22 "SSH"

# === 6. Отобразить внешний IP ===
echo "[INFO] Внешний IP-адрес:"
curl -s ifconfig.me
echo -e "\n"

# === 7. Получить сводку погоды ===
echo "[INFO] Прогноз погоды в Москве (4 дня):"
curl -s wttr.in/Moscow?format=%C+%t+%w+%p\&4
echo -e "\n"

# === Итоговый отчёт ===
echo "========== ИТОГОВЫЙ ОТЧЁТ =========="
check_service apache2
check_port 80 "Apache2"
check_apache_http
check_service ssh
check_port 22 "SSH"
echo "[INFO] Установка и проверка завершены."

